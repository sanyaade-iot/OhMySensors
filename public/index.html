<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">

    <title>OhMySensors</title>

    <script src="js/3rd/jquery.min.js"></script>
    <script src="js/3rd/blocks.min.js"></script>
    <script>
      var nodes = {};
      
      blocks.query({
        nodes: nodes
      });
      
      var socket = new WebSocket((window.location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
      socket.onopen = function(e) { console.log('connected'); };
      socket.onclose = function() { console.log('disconnected'); };
      socket.onerror = function(e) { console.log('error'); };

      socket.onmessage = function(message) {
        var object = JSON.parse(message.data);
        var name = object[0];
        var value = object[1];

        switch (name) {
          case 'nodeRegistered':
            nodes[value.nodeId] = {
              name: value.name,
              version: value.version,
              battery: value.battery,
              sensors: {}
            };
            break;
          case 'sensorRegistered':
            nodes[value.nodeId].sensors[value.childId] = {
              sensorId: value.sensorId,
              type: value.type,
              description: value.description,
              lastSeen: new Date(value.lastSeen),
              values: {}
            };
            break;
          case 'dataReceived':
            nodes[value.nodeId].sensors[value.childId].values[value.type] = value.value;
            break;
        }
        
        blocks.query({ nodes: nodes }); // Temporary
      };
    </script>
  </head>

  <body>
    <ul data-query="each(nodes)">
      <li>
        Node {{$index}}: {{$this.name}} - {{$this.version}}
        <ul>
          <li data-query="each($this.sensors)">
            Child {{$index}}: {{$this.type}} - {{$this.description}} - {{$this.lastSeen.toString()}}
            <ul>
              <li data-query="each($this.values)">
                {{$index}} = {{$this}}
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </body>
</html>